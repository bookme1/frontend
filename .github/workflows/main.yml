# .github/workflows/deploy-frontend.yml

on:
    push:
        branches:
            - main

name: ðŸš€ Deploy Frontend on Push

jobs:
    frontend-deploy:
        name: ðŸŽ‰ Deploy Frontend
        runs-on: ubuntu-latest
        steps:
            - name: ðŸšš Get latest code
              uses: actions/checkout@v4

            - name: Use Node.js 20
              uses: actions/setup-node@v2
              with:
                  node-version: '20'

            - name: ðŸ”¨ Build Frontend Project
              run: |
                  npm install
                  npm run build

            # Prepare deployable files, excluding files in .gitignore
            - name: Prepare Deployable Files
              run: |
                  mkdir deploy
                  git archive HEAD | tar -x -C deploy  # Copies files tracked by git, excluding .gitignore files

            # Frontend deploy in /bookme/client
            - name: ðŸ“‚ Deploy Frontend to /bookme/client
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.FTP_SERVER }}
                  username: ${{ secrets.FTP_USERNAME }}
                  password: ${{ secrets.FTP_PASSWORD }}
                  local-dir: ./deploy/.next/ # Deploy from the prepared deploy directory
                  server-dir: /bookme/client/

            # Sync frontend files from /bookme/client to /public_html, without deleting ignored files
            - name: ðŸ”„ Sync Frontend to /public_html
              run: |
                  sudo apt-get install lftp -y
                  lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_SERVER }} -e "
                  mirror -R --only-newer --delete deploy/ /public_html;  # Sync with --delete to remove old files
                  bye"
